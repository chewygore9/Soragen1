from flask import Flask, render_template, jsonify, request, send_file
import random, json, io

app = Flask(__name__)

# === same prompt banks ===
scene_options = [
    "A foggy bayou shack glowing with neon lights and mosquitos orbiting the lamp.",
    "Inside a Waffle House at 3AM after a failed heist.",
    "Munky and Glassy arguing in a busted UFO that crash-landed in a Walmart parking lot.",
    "Yerm preaching about loyalty while Tee Fred counts cash on a swamp boat.",
    "A therapy circle in the middle of the bayou surrounded by talking frogs.",
    "Post-apocalyptic gas station run by an alligator in sunglasses."
]

base_cameos = [
    ["@obesewith.munky"],
    ["@obesewith.glassy"],
    ["@obesewith.yerm"],
    ["@obesewith.teefred"],
    ["@obesewith.munky", "@obesewith.glassy"]
]

camera_options = [
    "handheld documentary zooms with sudden whip-pans",
    "smooth tracking shot through fog and neon reflections",
    "chaotic drone flyby that crashes mid-shot"
]

lighting_options = [
    "neon pink and teal glow reflecting off water",
    "warm golden sunlight breaking through swamp fog",
    "flickering fluorescent gas-station lights with bug shadows"
]

style_options = [
    "Adult Swim absurdist comedy",
    "Louisiana swamp noir",
    "vaporwave retro animation"
]

dialogue_options = [
    "“Sometimes I dream in 480p, bro.”",
    "“If it’s glowing, that means it’s money… or radiation.”",
    "“Down here, loyalty’s like gator teeth — sharp till it breaks.”"
]

sound_options = [
    "slow trap beat with frogs croaking in rhythm",
    "banjo trap remix with vinyl crackle"
]

mood_options = [
    "chaotic and hilarious",
    "trippy and dreamlike",
    "sincere but ridiculous"
]

def generate_prompt(custom_characters=None):
    cameos_list = base_cameos.copy()
    if custom_characters:
        for char in custom_characters:
            cameos_list.append([char])
    return {
        "model": "sora-2",
        "size": "1280x720",
        "seconds": random.choice([10, 11, 12]),
        "prompt": {
            "scene": random.choice(scene_options),
            "cameos": random.choice(cameos_list),
            "camera": random.choice(camera_options),
            "lighting": random.choice(lighting_options),
            "style": random.choice(style_options),
            "dialogue": random.choice(dialogue_options),
            "sound": random.choice(sound_options),
            "mood": random.choice(mood_options)
        }
    }

@app.route("/")
def index():
    return render_template("index.html")

@app.route("/generate", methods=["POST"])
def generate():
    data = request.get_json()
    custom_chars = data.get("custom", [])
    prompts = [generate_prompt(custom_chars), generate_prompt(custom_chars)]
    return jsonify(prompts)

@app.route("/cycle", methods=["POST"])
def cycle():
    data = request.get_json()
    base_scene = random.choice(scene_options)
    cameos = random.choice(base_cameos)
    base_dialogue = random.choice(dialogue_options)

    variants = []
    for _ in range(5):
        variant = {
            "model": "sora-2",
            "size": "1280x720",
            "seconds": random.choice([10, 11, 12]),
            "prompt": {
                "scene": base_scene,
                "cameos": cameos,
                "camera": random.choice(camera_options),
                "lighting": random.choice(lighting_options),
                "style": random.choice(style_options),
                "dialogue": base_dialogue,
                "sound": random.choice(sound_options),
                "mood": random.choice(mood_options)
            }
        }
        variants.append(variant)
    return jsonify({
        "base_scene": base_scene,
        "dialogue": base_dialogue,
        "cameos": cameos,
        "variants": variants
    })

@app.route("/download", methods=["POST"])
def download():
    data = request.get_json()
    filename = data.get("filename", "sora_prompts.json")
    json_str = json.dumps(data.get("content", {}), indent=2)
    buffer = io.BytesIO()
    buffer.write(json_str.encode("utf-8"))
    buffer.seek(0)
    return send_file(buffer, as_attachment=True, download_name=filename, mimetype="application/json")

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=81)