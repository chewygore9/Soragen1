<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SORA Wild Style Generator</title>
<style>
body {background:#0b0b0b; color:#0ff; font-family:monospace; padding:20px;}
button {background:#0ff; color:#000; border:none; padding:10px 20px; font-weight:bold; cursor:pointer; margin:5px;}
pre {background:#111; padding:10px; border:1px solid #0ff; white-space:pre-wrap;}
.copy {background:#333; color:#0ff; border:1px solid #0ff; margin-top:5px;}
input, textarea {background:#111; color:#0ff; border:1px solid #0ff; padding:8px; width:400px; font-family:monospace;}
textarea {height:100px; resize:vertical;}
.remix-section {border:2px solid #0ff; padding:20px; margin:20px 0; display:none;}
.remix-section.active {display:block;}
.input-row {margin:10px 0;}
</style>
</head>
<body>
<h1>üé¨ SORA Wild Style Generator</h1>
<button id="gen">Generate Two Prompts</button>
<button id="aiGen">ü§ñ AI Generate (GPT-4)</button>
<button id="cycle">üé® Style Cycler (5 Variants)</button>
<button id="snapRemix">üî• Snap Remix (Tyrone Style)</button>
<button id="remixToggle">üîÑ Remix Mode</button>
<button id="download">‚¨áÔ∏è Download JSON File</button>
<p>Project Notes (optional):</p>
<input id="notesInput" placeholder="Example: Weekend TikTok dropset, bayou noir vibe">

<div style="border:2px solid #ff00ff; padding:20px; margin:20px 0;">
  <h2>üîë Sora API Connection</h2>
  <div style="margin-bottom:10px;">
    <label style="color:#ff00ff;">API Provider:</label>
    <select id="apiProvider" style="background:#111; color:#0ff; border:1px solid #0ff; padding:5px; margin-left:10px;">
      <option value="openai">OpenAI Sora (Coming Soon)</option>
      <option value="kieai">Kie.AI Sora 2 Pro</option>
    </select>
  </div>
  <p id="apiInstructions">Enter your API key to enable direct video generation:</p>
  <input id="soraApiKey" type="password" placeholder="Enter API key..." style="width:400px;">
  <button id="saveSoraKey">üíæ Save Key</button>
  <button id="clearSoraKey">üóëÔ∏è Clear</button>
  <span id="soraStatus" style="margin-left:10px; font-weight:bold;"></span>
  <div id="soraFeatures" style="display:none; margin-top:15px;">
    <button id="generateSoraVideo" style="background:#ff00ff; color:#fff; font-size:1.2em; padding:15px;">üé¨ Generate Sora Video from Last Prompt</button>
    <div style="margin-top:10px;">
      <label>Duration (seconds): </label>
      <select id="videoDuration" style="background:#111; color:#0ff; border:1px solid #0ff; padding:3px;">
        <option value="5">5s</option>
        <option value="10" selected>10s</option>
        <option value="15">15s</option>
        <option value="20">20s</option>
      </select>
      <label style="margin-left:20px;">Resolution: </label>
      <select id="videoResolution" style="background:#111; color:#0ff; border:1px solid #0ff; padding:3px;">
        <option value="480p">480p</option>
        <option value="720p" selected>720p (HD)</option>
        <option value="1080p">1080p (Full HD)</option>
      </select>
    </div>
    <div id="soraVideoStatus" style="margin-top:10px;"></div>
  </div>
</div>

<div style="border:2px solid #0ff; padding:20px; margin:20px 0;">
  <h2>üíæ Save Custom Characters</h2>
  <p>Add characters you made in Sora (comma-separated):</p>
  <input id="saveCharsInput" list="charSuggestions" placeholder="@yourcharacter1, @yourcharacter2" style="width:500px;">
  <datalist id="charSuggestions">
    <option value="@obesewith.">
    <option value="@obesewith.munky">
    <option value="@obesewith.glassy">
    <option value="@obesewith.yerm">
    <option value="@obesewith.teefred">
  </datalist>
  <button id="saveCharsBtn">üíæ Save to Database</button>
  <div id="savedCharsList" style="margin-top:10px;"></div>
</div>

<div id="remixSection" class="remix-section">
  <h2>üéöÔ∏è Sora Remix Station</h2>
  <div class="input-row">
    <label>üìπ Sora Link:</label><br>
    <input id="soraLink" type="text" placeholder="Paste your Sora link here" style="width:100%;">
  </div>
  <div class="input-row">
    <label>ü•ö Remix Ingredients (JSON):</label><br>
    <textarea id="remixIngredients" placeholder='{"sound":"trap beats","style":"cyberpunk noir","lighting":"neon purple","mood":"surreal","seconds":10,"size":"1280x720"}' style="height:100px; width:100%;"></textarea>
  </div>
  <button id="remixBtn">üéõÔ∏è Remix It!</button>
  <div class="input-row" style="margin-top:15px;">
    <label>üìã Your Remix Prompt:</label><br>
    <textarea id="remixOutput" readonly placeholder="Your Remix Prompt will appear here..." style="height:200px; width:100%; background:#0a0a0a; color:#0ff; border:2px solid #0ff;"></textarea>
    <button class="copy" onclick="copyText('remixOutput')" style="margin-top:10px;">Copy Remix Prompt</button>
  </div>
</div>

<div id="results"></div>

<script>
let latestPrompts = [];
let soraApiKey = null;
let apiProvider = 'kieai'; // Default to Kie.AI

// Sora API Key Management
function initSoraAPI() {
  // Load saved provider and key from localStorage
  const savedProvider = localStorage.getItem('soraApiProvider') || 'kieai';
  const savedKey = localStorage.getItem(`soraApiKey_${savedProvider}`);
  
  document.getElementById('apiProvider').value = savedProvider;
  apiProvider = savedProvider;
  updateApiInstructions();
  
  if (savedKey) {
    soraApiKey = savedKey;
    document.getElementById('soraApiKey').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + savedKey.slice(-4); // Show last 4 chars
    document.getElementById('soraStatus').textContent = '‚úÖ Key Loaded';
    document.getElementById('soraStatus').style.color = '#0f0';
    document.getElementById('soraFeatures').style.display = 'block';
  } else {
    document.getElementById('soraStatus').textContent = '‚ùå No Key';
    document.getElementById('soraStatus').style.color = '#f00';
  }
}

function updateApiInstructions() {
  const provider = document.getElementById('apiProvider').value;
  const instructions = document.getElementById('apiInstructions');
  const keyInput = document.getElementById('soraApiKey');
  
  if (provider === 'openai') {
    instructions.textContent = 'Enter your OpenAI Sora API key (starts with sk-):';
    keyInput.placeholder = 'sk-...';
  } else {
    instructions.textContent = 'Enter your Kie.AI API key:';
    keyInput.placeholder = 'Your Kie.AI API key...';
  }
}

document.getElementById('apiProvider').addEventListener('change', (e) => {
  apiProvider = e.target.value;
  localStorage.setItem('soraApiProvider', apiProvider);
  updateApiInstructions();
  
  // Load key for this provider if exists
  const savedKey = localStorage.getItem(`soraApiKey_${apiProvider}`);
  if (savedKey) {
    soraApiKey = savedKey;
    document.getElementById('soraApiKey').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + savedKey.slice(-4);
    document.getElementById('soraStatus').textContent = '‚úÖ Key Loaded';
    document.getElementById('soraStatus').style.color = '#0f0';
    document.getElementById('soraFeatures').style.display = 'block';
  } else {
    soraApiKey = null;
    document.getElementById('soraApiKey').value = '';
    document.getElementById('soraStatus').textContent = '‚ùå No Key';
    document.getElementById('soraStatus').style.color = '#f00';
    document.getElementById('soraFeatures').style.display = 'none';
  }
});

document.getElementById('saveSoraKey').addEventListener('click', () => {
  const keyInput = document.getElementById('soraApiKey').value.trim();
  const provider = document.getElementById('apiProvider').value;
  
  if (!keyInput) {
    alert('Please enter an API key');
    return;
  }
  
  // Validate based on provider
  if (provider === 'openai' && !keyInput.startsWith('sk-')) {
    alert('OpenAI keys should start with sk-');
    return;
  }
  
  soraApiKey = keyInput;
  localStorage.setItem(`soraApiKey_${provider}`, keyInput);
  document.getElementById('soraApiKey').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + keyInput.slice(-4);
  document.getElementById('soraStatus').textContent = '‚úÖ Key Saved';
  document.getElementById('soraStatus').style.color = '#0f0';
  document.getElementById('soraFeatures').style.display = 'block';
  alert(`${provider === 'openai' ? 'OpenAI Sora' : 'Kie.AI'} API key saved locally! You can now generate videos.`);
});

document.getElementById('clearSoraKey').addEventListener('click', () => {
  if (confirm('Remove your Sora API key?')) {
    const provider = document.getElementById('apiProvider').value;
    soraApiKey = null;
    localStorage.removeItem(`soraApiKey_${provider}`);
    document.getElementById('soraApiKey').value = '';
    document.getElementById('soraStatus').textContent = '‚ùå No Key';
    document.getElementById('soraStatus').style.color = '#f00';
    document.getElementById('soraFeatures').style.display = 'none';
    alert('API key removed');
  }
});

document.getElementById('generateSoraVideo').addEventListener('click', async () => {
  if (!soraApiKey) {
    alert('Please enter your API key first!');
    return;
  }
  
  if (!latestPrompts || latestPrompts.length === 0) {
    alert('Generate a prompt first, then click this button to create a video!');
    return;
  }
  
  const provider = document.getElementById('apiProvider').value;
  const statusDiv = document.getElementById('soraVideoStatus');
  const duration = document.getElementById('videoDuration').value;
  const resolution = document.getElementById('videoResolution').value;
  
  statusDiv.innerHTML = '<div style="color:#ff00ff;">üé¨ Generating video... (this may take a few moments)</div>';
  
  // Get the most recent prompt
  const promptToUse = latestPrompts[0].sora_prompt || latestPrompts[0].prompt || JSON.stringify(latestPrompts[0]);
  
  try {
    if (provider === 'kieai') {
      // Use Flask backend route for Kie.AI
      const response = await fetch('/api/sora-generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          api_key: soraApiKey,
          prompt: promptToUse,
          duration: parseInt(duration),
          resolution: resolution
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.url) {
          statusDiv.innerHTML = `
            <div style="color:#0f0;">‚úÖ Video generated with Kie.AI Sora 2 Pro!</div>
            <div style="margin-top:10px;">
              <a href="${data.url}" target="_blank" style="color:#ff00ff; font-size:1.2em;">üé• View Your Video</a>
            </div>
            <div style="margin-top:5px; color:#888;">Duration: ${duration}s | Resolution: ${resolution}</div>
          `;
        } else if (data.status === 'processing') {
          statusDiv.innerHTML = `
            <div style="color:#ff0;">‚è≥ Video is being processed...</div>
            <div style="color:#888; margin-top:5px;">Check back in a few moments. Job ID: ${data.job_id}</div>
          `;
        }
      } else {
        const error = await response.json();
        statusDiv.innerHTML = `<div style="color:#f00;">‚ùå Error: ${error.error || 'Failed to generate video'}</div>`;
      }
    } else {
      // OpenAI Sora (placeholder for when available)
      const response = await fetch('https://api.openai.com/v1/video/generations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${soraApiKey}`
        },
        body: JSON.stringify({
          model: 'sora-2',
          prompt: promptToUse,
          duration: parseInt(duration),
          size: resolution === '480p' ? '854x480' : resolution === '720p' ? '1280x720' : '1920x1080'
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        statusDiv.innerHTML = `
          <div style="color:#0f0;">‚úÖ Video generated with OpenAI Sora!</div>
          <div style="margin-top:10px;">
            <a href="${data.url}" target="_blank" style="color:#ff00ff;">üé• View Your Video</a>
          </div>
        `;
      } else {
        if (response.status === 404) {
          statusDiv.innerHTML = `
            <div style="color:#ff0;">‚ö†Ô∏è OpenAI Sora API is not yet publicly available</div>
            <div style="color:#888; margin-top:5px;">Your key is saved for when it becomes available!</div>
            <div style="margin-top:10px;">For now, try using Kie.AI Sora 2 Pro or copy your prompts to: 
              <a href="https://sora.openai.com" target="_blank" style="color:#ff00ff;">sora.openai.com</a>
            </div>
          `;
        } else {
          const error = await response.text();
          statusDiv.innerHTML = `<div style="color:#f00;">‚ùå Error: ${error}</div>`;
        }
      }
    }
  } catch (err) {
    statusDiv.innerHTML = `
      <div style="color:#ff0;">‚ö†Ô∏è API Connection Issue</div>
      <div style="color:#888; margin-top:5px;">Error: ${err.message}</div>
      <div style="margin-top:10px;">Check your API key and try again.</div>
    `;
  }
});

// Initialize on page load
window.addEventListener('load', () => {
  initSoraAPI();
});

async function loadSavedCharacters(){
  const res = await fetch('/get_characters');
  const data = await res.json();
  const charsList = document.getElementById('savedCharsList');
  if(data.characters.length > 0){
    charsList.innerHTML = `<h3>Your Saved Characters:</h3><pre style="color:#0f0;">${data.characters.join(', ')}</pre>`;
  } else {
    charsList.innerHTML = '<p style="color:#888;">No saved characters yet.</p>';
  }
}

document.getElementById('saveCharsBtn').addEventListener('click', async ()=>{
  const chars = document.getElementById('saveCharsInput').value;
  if(!chars){
    alert('Enter some character names first!');
    return;
  }
  const res = await fetch('/save_characters',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({characters: chars})
  });
  const data = await res.json();
  alert(data.message);
  document.getElementById('saveCharsInput').value = '';
  loadSavedCharacters();
});

window.addEventListener('load', loadSavedCharacters);

async function getPrompts(){
  const res = await fetch('/generate');
  const data = await res.json();
  latestPrompts = data;
  const box = document.getElementById('results');
  box.innerHTML = '';
  data.forEach((p,i)=>{
    const j = JSON.stringify(p, null, 2);
    box.innerHTML += `
      <h2>Prompt #${i+1}</h2>
      <pre id="out${i}">${j}</pre>
      <button class="copy" onclick="copyText('out${i}')">Copy</button>
    `;
  });
}

function copyText(id){
  const el = document.getElementById(id);
  // Handle both textarea (value) and pre/div elements (innerText)
  const text = el.value || el.innerText || el.textContent;
  navigator.clipboard.writeText(text).then(() => {
    alert('Copied to clipboard!');
  }).catch(err => {
    // Fallback for older browsers or permission issues
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('Copied to clipboard!');
  });
}

document.getElementById('gen').addEventListener('click', getPrompts);

document.getElementById('aiGen').addEventListener('click', async ()=>{
  const notes = document.getElementById('notesInput').value;
  const box = document.getElementById('results');
  box.innerHTML = '<h2>ü§ñ Generating with GPT-4...</h2>';
  
  try {
    const res = await fetch('/ai_generate',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({notes: notes})
    });
    
    if (!res.ok) {
      const error = await res.json();
      box.innerHTML = `<h3 style="color:red;">Error: ${error.error || 'AI generation not available'}</h3>`;
      return;
    }
    
    const data = await res.json();
    latestPrompts = data;
    box.innerHTML = '';
    
    data.forEach((p,i)=>{
      const j = JSON.stringify(p, null, 2);
      box.innerHTML += `
        <h2>AI Prompt #${i+1}</h2>
        <pre id="ai${i}">${j}</pre>
        <button class="copy" onclick="copyText('ai${i}')">Copy</button>
      `;
    });
  } catch(e) {
    box.innerHTML = `<h3 style="color:red;">Error: Failed to generate</h3>`;
  }
});

document.getElementById('cycle').addEventListener('click', async ()=>{
  const res = await fetch('/cycle',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({})
  });
  const data = await res.json();
  latestPrompts = data;
  const box = document.getElementById('results');
  box.innerHTML = `<h2>üé≠ Base Scene:</h2>
  <pre id="baseScene">${data.base_scene}</pre>
  <button class="copy" onclick="copyText('baseScene')">Copy</button>
  <h3>üí¨ Dialogue:</h3>
  <pre id="dialogue">${data.dialogue}</pre>
  <button class="copy" onclick="copyText('dialogue')">Copy</button>
  <h3>üé¨ Cameos:</h3>
  <pre id="cameos">${data.cameos.join(', ')}</pre>
  <button class="copy" onclick="copyText('cameos')">Copy</button>`;

  data.variants.forEach((v,i)=>{
    const j = JSON.stringify(v, null, 2);
    box.innerHTML += `
      <h2>Variant #${i+1}</h2>
      <pre id="var${i}">${j}</pre>
      <button class="copy" onclick="copyText('var${i}')">Copy</button>
    `;
  });
});

document.getElementById('remixToggle').addEventListener('click', ()=>{
  const section = document.getElementById('remixSection');
  section.classList.toggle('active');
});

// Snap Remix functionality
document.getElementById('snapRemix').addEventListener('click', async ()=>{
  const box = document.getElementById('results');
  box.innerHTML = '<div style="text-align:center;">üî• GENERATING SNAP REMIX...</div>';
  
  // Show personality selector
  const personalities = ['calm', 'witty', 'unhinged'];
  const selectedPersonality = prompt('Choose personality:\n- calm (smooth cinematic)\n- witty (sarcastic comedy)\n- unhinged (pure chaos)\n\nEnter: calm, witty, or unhinged', 'unhinged');
  
  const personality = personalities.includes(selectedPersonality) ? selectedPersonality : 'unhinged';
  
  const res = await fetch('/snap_remix', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({personality: personality})
  });
  
  const data = await res.json();
  latestPrompts = [data];
  
  box.innerHTML = `
    <h2>üî• SNAP REMIX - ${data.personality.toUpperCase()} MODE</h2>
    <h3>üé¨ Scene:</h3>
    <pre id="snapScene">${data.scene}</pre>
    <button class="copy" onclick="copyText('snapScene')">Copy Scene</button>
    
    <h3>üë• Characters:</h3>
    <pre id="snapChars">${data.characters.join(', ')}</pre>
    <button class="copy" onclick="copyText('snapChars')">Copy Characters</button>
    
    <h3>‚öôÔ∏è Config:</h3>
    <pre id="snapConfig">Duration: ${data.duration}s
Theme: ${data.theme}
Lighting: ${data.config.lighting}
Camera: ${data.config.camera}
Visual: ${data.config.visual}
Audio: ${data.config.audio}
Text Style: ${data.config.text_style}
Call To Action: ${data.config.cta}</pre>
    <button class="copy" onclick="copyText('snapConfig')">Copy Config</button>
    
    <h3>üéØ SORA PROMPT (Copy This!):</h3>
    <pre id="snapPrompt" style="background:#111; border:3px solid #f0f;">${data.sora_prompt}</pre>
    <button class="copy" onclick="copyText('snapPrompt')" style="font-size:1.2em; padding:15px;">üî• COPY SNAP REMIX PROMPT</button>
  `;
});

document.getElementById('remixBtn').addEventListener('click', () => {
  const soraLink = document.getElementById('soraLink').value.trim();
  const remixJSON = document.getElementById('remixIngredients').value.trim();

  if (!soraLink) {
    alert('‚ö†Ô∏è Missing Sora link!');
    return;
  }
  if (!remixJSON) {
    alert('‚ö†Ô∏è Missing Remix JSON!');
    return;
  }

  let remixData;
  try {
    remixData = JSON.parse(remixJSON);
  } catch (err) {
    alert('‚ùå Invalid JSON format!');
    console.error(err);
    return;
  }

  // Check if data is nested in a "prompt" object (new Sora format) or flat
  const promptData = remixData.prompt || remixData;
  
  // Build the remix prompt with clean formatting
  let remixPrompt = `üé¨ Recreate the following Sora scene:\n\n`;
  remixPrompt += `üé• Original Video: ${soraLink}\n\n`;
  remixPrompt += `üéöÔ∏è Remix Ingredients:\n`;
  
  // Handle all possible fields from both formats
  if (promptData.scene) {
    remixPrompt += `‚Ä¢ Scene: ${promptData.scene}\n`;
  }
  if (promptData.cameos && Array.isArray(promptData.cameos)) {
    remixPrompt += `‚Ä¢ Cameos: ${promptData.cameos.join(', ')}\n`;
  }
  if (promptData.dialogue) {
    remixPrompt += `‚Ä¢ Dialogue: "${promptData.dialogue}"\n`;
  }
  if (promptData.camera) {
    remixPrompt += `‚Ä¢ Camera: ${promptData.camera}\n`;
  }
  if (promptData.sound) {
    remixPrompt += `‚Ä¢ Sound: ${promptData.sound}\n`;
  }
  if (promptData.style) {
    remixPrompt += `‚Ä¢ Style: ${promptData.style}\n`;
  }
  if (promptData.lighting) {
    remixPrompt += `‚Ä¢ Lighting: ${promptData.lighting}\n`;
  }
  if (promptData.mood) {
    remixPrompt += `‚Ä¢ Mood: ${promptData.mood}\n`;
  }
  
  // Handle root-level properties (seconds, size, model)
  if (remixData.model) {
    remixPrompt += `‚Ä¢ Model: ${remixData.model}\n`;
  }
  if (remixData.seconds) {
    remixPrompt += `‚Ä¢ Seconds: ${remixData.seconds}\n`;
  }
  if (remixData.size) {
    remixPrompt += `‚Ä¢ Size: ${remixData.size}\n`;
  }

  document.getElementById('remixOutput').value = remixPrompt.trim();
});

document.getElementById('download').addEventListener('click', async ()=>{
  if(!latestPrompts || (Array.isArray(latestPrompts) && !latestPrompts.length) || (!Array.isArray(latestPrompts) && !Object.keys(latestPrompts).length)){
    alert('Generate something first!');
    return;
  }
  const notes = document.getElementById('notesInput').value;
  const res = await fetch('/download',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      filename:'sora_prompts.json',
      notes: notes,
      content: latestPrompts
    })
  });
  if(res.ok){
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sora_prompts.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }
});
</script>
</body>
</html>